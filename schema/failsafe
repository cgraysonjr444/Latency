import ping from "npm:ping";

async function checkSystemLatency() {
    const host = '192.168.1.1'; 
    
    try {
        const start = performance.now();
        
        // 1. Attempt the API Fetch
        const response = await fetch("https://api.latency.app/grooves");
        
        if (!response.ok) {
            throw new Error(`API responded with status: ${response.status}`);
        }

        const end = performance.now();
        const requestLatency = Math.round(end - start);
        
        // 2. Attempt the Router Ping
        const pingRes = await ping.promise.probe(host);
        
        console.log(`Current IT Latency: ${requestLatency}ms`);
        console.log(`Router Ping (${host}): ${pingRes.time}ms`);
        
        // 3. Logic Bridge
        if (requestLatency > 50) {
            saveMetric('network_lag', requestLatency);
        }

    } catch (error) {
        // 4. THE FAIL-SAFE: Log the error without crashing the script
        console.error("[MONITOR ERROR]: System potentially offline or API unreachable.");
        console.error(`Details: ${error.message}`);
        
        // Optional: Flag the system as 'Down' in your metrics
        saveMetric('system_status', 0); // 0 for offline
    }
}

function saveMetric(type, value) {
    console.warn(`[METRIC] Recording ${type}: ${value}ms`);
}

// Initial run and interval
checkSystemLatency();
setInterval(checkSystemLatency, 60000);
